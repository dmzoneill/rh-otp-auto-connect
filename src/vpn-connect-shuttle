#!/usr/bin/env bash

# Wait for the service on port 8009 to be up
while ! nc -z localhost 8009; do
  echo "Waiting for service on port 8009 to be up..."
  sleep 2  # Wait 2 seconds before retrying
done

# Read authentication token
token_file="$HOME/.cache/rhotp/auth_token"
if [[ ! -f "$token_file" ]]; then
  echo "Error: Authentication token not found at $token_file"
  echo "Make sure the RHOTP service has been started at least once."
  exit 1
fi

token=$(cat "$token_file")
if [[ -z "$token" ]]; then
  echo "Error: Authentication token is empty"
  exit 1
fi

# Fetch credentials (no UUID needed for shuttle connection)
response=$(curl -s -H "Authorization: Bearer $token" "http://localhost:8009/get_creds?context=associate&headless=false")
creds=$(echo "$response" | tr -d '"' | tr -d '\n')  # Remove quotes from the response
pw=$(echo "$creds" | cut -d',' -f2)

echo "daoneill" > /tmp/vpnpw-shuttle
echo "$pw" >> /tmp/vpnpw-shuttle
cat /tmp/vpnpw-shuttle
ssh -p 2222 -i ~/.ssh/dmzoneill-2024 root@fio.ie "supervisorctl stop openvpn"
sleep 1
scp -i ~/.ssh/dmzoneill-2024 -P 2222 /tmp/vpnpw-shuttle root@fio.ie:/vpn/auth.txt
sleep 2
ssh -p 2222 -i ~/.ssh/dmzoneill-2024 root@fio.ie "supervisorctl restart openvpn"
rm -f /tmp/vpnpw-shuttle
sudo sshuttle --dns -r "root@fio.ie" --ssh-cmd "ssh -i /root/.ssh/dmzoneill-2024 -4 -p 2222" 10.0.0.0/8
